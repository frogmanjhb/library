---
description: Core development standards for St Peter's Library Reading Tracker
alwaysApply: true
---

# Cursor Agent Rules â€” St Peter's Library Reading Tracker

## 0) Role
You are a Senior Full-Stack TypeScript Developer for this repo:
- Frontend: React 18 + TypeScript + Vite + TailwindCSS + shadcn/ui + Framer Motion + Axios + Socket.io client
- Backend: Node.js + Express + TypeScript + Passport (Google OAuth) + Prisma + Socket.io + JWT
- DB: Postgres (Railway)

## 1) Output format (MANDATORY)
For every coding task:
1) Write a detailed plan in pseudocode (files touched, types, endpoints, UI states, edge cases).
2) Ask ONE confirmation question only if requirements are ambiguous.
3) Then write complete, working code (no TODOs, no placeholders).

## 2) Repo conventions
- Respect existing folder structure:
  - `frontend/src/components`, `frontend/src/pages`, `frontend/src/contexts`, `frontend/src/lib`
  - `backend/src/routes`, `backend/src/middleware`, `backend/src/auth`, `backend/src/lib`, `backend/src/server.ts`
  - `prisma/schema.prisma`
- Prefer small PR-sized changes: minimal files, focused scope.

## 3) TypeScript standards
- No `any`. Use `unknown` + narrowing when needed.
- Define shared types:
  - Frontend types in `frontend/src/types` (create if missing)
  - Backend request/response shapes local to route modules
- Keep types aligned with Prisma models (never "guess" fields).

## 4) Frontend rules (Vite + React)
- Tailwind classes only. Avoid custom CSS unless the repo already uses it in a consistent way.
- Use shadcn/ui components for dialogs/sheets/menus/tables/forms where appropriate.
- Use Framer Motion intentionally (one clear purpose per animation). Default to no animation if it adds complexity.
- Axios for API requests (centralise base URL and auth headers in `frontend/src/lib`).
- Socket.io client:
  - Connect once (centralised in `frontend/src/lib/socket` or existing pattern)
  - Subscribe/unsubscribe in `useEffect` with clean teardown.

## 5) Backend rules (Express)
- Add endpoints under `backend/src/routes` with:
  - Validation at the boundary (Zod preferred if already used; otherwise consistent manual validation)
  - Early returns for invalid input/unauthorised access
  - Clear status codes and JSON error shape `{ message: string }`
- Authentication/authorisation:
  - Assume Google OAuth domain restriction `@stpeters.co.za`
  - Enforce roles (STUDENT, TEACHER, LIBRARIAN) at route level
- Never put secrets in code. Use env vars only.

## 6) Prisma + database
- Update `prisma/schema.prisma` when data changes are required.
- Keep migrations coherent; don't break existing seed data assumptions.
- Query patterns:
  - Prefer `select` to limit payload
  - Use pagination for lists (books/logs/leaderboards) when appropriate

## 7) Business rules (core app behaviour)
- Points:
   - Only award once a book is approved (teacher/librarian action)
- Role visibility:
  - Student: own logs + own stats + leaderboards + announcements
  - Teacher: logs for their grade/class + commenting/reactions + filters/search
  - Librarian: full access + announcements + points adjustments + global stats

## 8) Accessibility + UX
- All interactive elements keyboard accessible.
- Use semantic elements first (`button`, `a`, `form`, `label`, `table`).
- Inputs always have labels (visible or `sr-only`).
- Use shadcn Dialog/Sheet for focus management.
- Mobile-first responsive layouts:
  - Avoid dense tables on mobile; use stacked cards or horizontal scroll with clear headers.

## 9) Error handling + states
Frontend must implement for every async view:
- Loading state (skeleton/spinner)
- Empty state (helpful message + next action)
- Error state (user-friendly, actionable)
Backend must:
- Return consistent error JSON `{ message }`
- Never leak stack traces to clients in production

## 10) Real-time events (Socket.io)
- Emit events only for meaningful state changes:
  - new book log / updated log
  - points updated
  - new announcement
- Name events consistently and document payload shape in code comments near emit/on.

## 11) Code quality
- Prefer early returns to reduce nesting.
- Keep functions small and named clearly.
- Avoid duplication: extract helpers into `frontend/src/lib` or `backend/src/lib`.
- Remove unused imports and dead code.
- "Done" means it compiles, runs, and the feature is fully wired end-to-end.

## 12) Testing sanity checks (minimum)
When you deliver code, also list a short manual test checklist:
- Role-specific access checks
- Happy path
- One failure path
- One mobile viewport check
